## 26 主题 I: 创建主题和模板

主题允许更改站点的图形外观或设计。一个主题由一组扩展名为 `.html.twig` 的文件组成，这些文件是 Twig 格式的模板文件，用于站点的不同区域。除了模板文件，模块和主题还可以实现一组 PHP 函数，这些函数允许干预系统并修改最终的 HTML 输出。

通过更改 CSS 样式表和模板文件，可以轻松地修改主题。每个模板接受一组预定义的变量，这些变量将在显示网站时被替换为实际值。

在本单元中，我们将学习如何从基础主题创建一个主题，以及如何使用模板和预处理函数。我们还将学习如何通过修改配置表单来扩展主题的配置选项。

请注意，在本课程中，我们从后端开发人员的角度研究主题。在前端开发课程中，我们将扩展这些内容，并深入研究 HTML 和 CSS 的布局，以及响应式主题的开发。

### 单元内容

- 26.1 创建主题
- 26.2 模板文件
- 26.3 Drupal 中的 Twig
- 26.4 模板预处理函数
- 26.5 主题配置表单
- 26.6 使用控制台进行操作
# 26.1 创建主题

### 主题的结构

一个主题由一组定义站点展示层的文件组成。贡献的或自定义开发的主题存储在我们安装的 `/themes` 文件夹中。在每个主题的文件夹中，我们会看到类似于以下的文件和文件夹结构：

```
themes/
  exampletheme/
    exampletheme.breakpoints.yml
    exampletheme.info.yml
    exampletheme.libraries.yml
    exampletheme.theme
    logo.png
    screenshot.png

    config/
    install/
      exampletheme.settings.yml
    schema/
      exampletheme.schema.yml
    css/
      style.css
    js/
      exampletheme.js
    images/
      buttons.png
    templates/
      maintenance-page.html.twig
      node.html.twig
      page.html.twig
```

### 各个文件的用途

- **`*.info.yml`**: 主题中==唯一必需==的文件。该文件包含主题的定义和一些通用配置选项（区域、CSS 文件等）。文件名 `*.info.yml` 定义了主题的系统名称，通常包含在同名文件夹中。例如，在 `exampletheme` 文件夹中，我们会找到 `exampletheme.info.yml` 文件。主题的内部名称将是 `exampletheme`。虽然文件夹名称不一定要与主题的内部名称一致，但建议保持一致。
- **`*.libraries.yml`**: 该文件定义了主题使用的库（CSS 和 JS 文件）。
- **`*.breakpoints.yml`**: ==断点==定义了响应式设计中主题根据设备变化的条件。
- **`*.theme`**: 一个包含与主题相关的 PHP 代码的文件，通常用于输出的预处理。
- **`logo.png`（或 `logo.svg`）**: 主题中包含的默认 logo 文件。我们可以更改此 logo 或从主题配置中上传新的 logo 图片。
- **`screenshot.png`**: 主题的预览图像，用于主题列表（外观）中。
- **`css/`**: 存放主题 CSS 文件（`*.css`）的文件夹。这些文件在 `*.libraries.yml` 文件中定义。
- **`js/`**: 存放主题 JavaScript 文件（`*.js`）的文件夹。这些文件在 `*.libraries.yml` 文件中定义。
- **`images/`**: 主题使用的图像（图标、背景、边框等）。
- **`templates/`**: 包含模板文件，扩展名为 `*.html.twig`。在 Drupal 10 中，模板文件使用 Twig 编写，Twig 是 HTML、变量和 Twig 代码的混合，用于生成最终的 HTML 输出。我们将在后续部分中详细讨论这种格式。
  - 主题中包含的模板会覆盖默认输出。例如，`node.html.twig` 文件修改了站点所有节点的输出。包含此文件即覆盖了核心模块 `node` 中的默认模板文件。如果未包含特定模板，系统将使用默认模板。
- **`config/`**: 包含配置文件（`*.yml`），这些文件在主题安装期间会考虑默认参数。

### `*.info.yml` 文件

`themename.info.yml` 文件包含主题的定义和一些通用配置选项（区域、CSS 文件等）。文件名 `themename.info.yml` 定义了主题的系统名称，通常包含在同名文件夹中。与模块名称类似，系统名称应全部小写且不含空格，使用下划线代替。

定义 `*.info.yml` 文件后，主题将在站点的主题列表中可见：

- 管理 -> 外观
- URL: `/admin/appearance`

`*.info.yml` 文件包含一系列参数（键/值），格式为 YAML。所有可用参数可以在以下链接找到：

[定义主题的 info.yml 文件](https://www.drupal.org/docs/theming-drupal/defining-a-theme-with-an-infoyml-file)

以下是一些常用参数的示例：

```yaml
name: 'Foo Theme'
type: theme
base theme: bartik
description: 'A flexible, recolorable theme with many regions and a responsive, mobile-first layout.'
package: Examples
core_version_requirement: ^9
libraries:
  - foo_theme/global-styling
regions:
  header: Header
  primary_menu: 'Primary menu'
  secondary_menu: 'Secondary menu'
  page_top: 'Page top'
  page_bottom: 'Page bottom'
  highlighted: Highlighted
  featured_top: 'Featured top'
  breadcrumb: Breadcrumb
  content: Content
  sidebar_first: 'Sidebar first'
  sidebar_second: 'Sidebar second'
  featured_bottom_first: 'Featured bottom first'
  featured_bottom_second: 'Featured bottom second'
  featured_bottom_third: 'Featured bottom third'
  footer_first: 'Footer first'
  footer_second: 'Footer second'
  footer_third: 'Footer third'
  footer_fourth: 'Footer fourth'
  footer_fifth: 'Footer fifth'
```

- **`name`**: 主题的名称，如在管理列表中显示。如果名称包含多个单词，使用单引号括起来。
- **`type`**: 对于主题，始终为 `theme`。
- **`base theme`**: 如果我们的主题继承自另一个主题，在此处包含基础主题的名称。如果未指定，默认使用 `stable` 基础主题。
- **`description`**: 在主题列表（外观）中显示的主题描述。
- **`package`**: 用于将相关主题分组的组名。
- **`core_version_requirement`**: 指定 Drupal 的版本，与模块相同（第 16.1 节）。
- **`libraries`**: 推荐的添加 CSS 和 JavaScript 文件的方法是包含库。库中的文件将在使用主题时加载。我们稍后将讨论如何定义它们。
- **`regions`**: 区域是主题中可以放置站点块的区域。包含一个区域列表，为每个区域指定系统名称和在块管理区域中显示的名称。如果区域名称包含多个单词，使用单引号括起来。
  - `content` 区域是唯一必需的区域，用于显示页面内容。
### 区域

为了模块和核心模板之间的兼容性，建议使用与核心主题相同的区域名称。这样，当我们更改站点的主题时，块会正确地定位在新主题的相应区域中。

每个区域的内容是动态的，取决于从站点的块管理区域添加到每个区域的块。

==区域在 `page.html.twig` 模板中使用，==格式为 `page.nombre_region` ：

```html
<div id="page-wrapper">
  <div id="page">
    <header id="header" class="header" role="banner" aria-label="{{ 'Site header'|t }}">
      <div class="section layout-container clearfix">
        {{ page.secondary_menu }}
        {{ page.header }}
        {{ page.primary_menu }}
      </div>
    </header>
    {% if page.highlighted %}
      <div class="highlighted">
        <aside class="layout-container section clearfix" role="complementary">
          {{ page.highlighted }}
        </aside>
      </div>
    {% endif %}
  </div>
</div>
```

系统将负责创建这些内容，查找活动块、它们的顺序等，并为每个区域返回已组成的 HTML。正如我们将看到的，这些 HTML 代码依赖于我们在主题中定义的其他次级模板。

==要添加自定义区域==，请按照以下步骤操作：

1. 在主题的 `.info.yml` 文件中定义区域。
2. 在主题的 `page.html.twig` 模板中添加额外的 HTML 和变量 `page.nombre_region`。

### 基础主题和子主题

在将主题集成到我们的网站时，我们可以采用多种策略：

1. **安装普通主题**：普通主题是指任何直接用于我们网站的主题（除了基础主题之外的所有主题都是普通主题）。需要注意更新。系统会提醒我们可能的主题更新，但如果我们更新，可能会覆盖在主题中所做的更改（例如，在模板或 CSS 文件中）。
2. **安装普通主题并更改名称**：为了避免更新问题，可以选择更改主题名称，通常更改为我们网站的名称。过程非常简单，下载主题并更改文件名和函数名中引用的原始名称。修改后，可以将主题上传到主机并按常规方式安装。
3. **从基础主题创建子主题**：基础主题设计用于通过子主题扩展。它们提供基本功能和样式，子主题将继承这些功能和样式。所有模板和样式表的修改都将在子主题中进行，保持基础主题文件不变。基础主题可以更新到新版本，因为我们只在子主题中进行更改。

   Drupal 主题库中有许多基础主题可用，例如：
   - [Barrio (Bootstrap 4/5)](https://www.drupal.org/project/bootstrap_barrio)
   - [Bootstrap 4](https://www.drupal.org/project/bootstrap4)
   - [Bootstrap 5](https://www.drupal.org/project/bootstrap5)
   - [Zurb Foundation](https://www.drupal.org/project/zurb_foundation)

   基础主题可能有不同的安装说明，因此首先需要在项目页面或主题文件夹中的 `README.txt` 文件中找到这些说明。

4. **从普通主题创建子主题**：任何主题都可以通过子主题扩展。这样，子主题将继承原始主题的所有样式和模板。由于我们在子主题中进行更改，使用的基础主题可以无问题地更新。
5. **从零开始创建自定义主题**：由于成本高，这种选择几乎被排除。如果我们想从零开始，最好从基础主题开始（第 3 点）。
6. **安装带有安装配置文件的主题**：越来越多的主题，特别是付费主题，作为安装配置文件或 Drupal 发行版进行安装。这些发行版除了主题外，还创建所有必要的元素（内容类型、视图、分类法等）和示例内容。这样，一旦安装，我们将有一个非常完整的 DEMO 站点，可以开始进行修改。这是一种快速开始工作的方式，可以在短时间内准备好一个站点，但也有一些缺点：
   - 安装发行版意味着从零开始安装 Drupal，因此不能在已安装的站点上应用。
   - 安装配置文件添加了元素（内容类型、块、视图等），因此我们需要对站点进行预先研究，以了解其结构并能够修改任何元素。
   - 主题/发行版作者在实现站点结构时采用的策略，可能会迫使我们遵循不总是最合适的路径。

**新功能：Drupal 10**

**Starterkit 主题**

[Starterkit 主题](https://www.drupal.org/docs/core-modules-and-themes/core-themes/starterkit-theme)

### 从 Bartik 创建子主题

正如我们之前提到的，可以从任何主题创建子主题，即使它不是基础主题。接下来，我们将使用核心主题 Bartik 作为基础主题，创建一个名为 Forcontu Bartik（`forcontu_bartik`）的主题。

#### 步骤 1. 创建主题文件夹和定义文件

我们先在本地工作，稍后将创建的文件夹和文件结构上传到服务器。

a) 创建文件夹 `forcontu_bartik`。该主题将位于 `/themes/custom` 文件夹中。

注意：如果需要，请调整 IDE 的配置，以便访问和同步此文件夹，或创建一个新项目。

b) 在根文件夹中创建 `forcontu_bartik.info.yml` 文件。在该文件中添加以下内容：

```yaml
name: 'Forcontu Bartik'
type: theme
base theme: bartik
description: 'Subtema a partir de Bartik'
core_version_requirement: ^9
libraries:
  - forcontu_bartik/global-styling
```

指定的参数如下：

- **name**: 主题在主题列表中显示的名称。系统名称由 `.info.yml` 文件名定义，因此在我们的例子中，系统名称是 `forcontu_bartik`。
- **type**: 类型为 `theme`。
- **base theme**: 指定将用作基础的主题的系统名称，在我们的例子中是 `bartik`。
- **core_version_requirement**: 指定与 Drupal 版本的兼容性。在此例中，我们未指定具体版本，表示适用于任何 Drupal 10 版本（`^9`）。
- **libraries**: 创建一个名为 `global-styling` 的库组。在该组中将定义主题的 CSS 文件。

#### 步骤 2. 创建库定义文件

接下来，在根文件夹中创建 `forcontu_bartik.libraries.yml` 文件。

```yaml
global-styling:
  css:
    theme:
      css/style.css: {}
```

我们指定主题将有一个位于 `css` 文件夹中的新文件 `style.css`。

#### 步骤 3. 创建 CSS 文件

a) 创建 `css` 文件夹（在 `forcontu_bartik` 文件夹内）。

b) 进入 `css` 文件夹并创建 `style.css` 文件。暂时在文件中添加以下内容：

```css
#header {
  background-color: #C7D0D6;
  background-image: none;
}
```

#### 步骤 4. Logo 和预览文件

将默认 logo 文件（`logo.svg`）和主题预览图像（`screenshot.png`）上传到根文件夹。你可以创建自己的图像或从 Bartik 主题（`/core/themes/bartik`）中复制这些文件。

#### 步骤 5. 安装 Forcontu Bartik 主题

将主题文件夹上传到服务器的 `/themes/custom` 文件夹中。服务器上的结构如下：

```
themes/
  custom/
    forcontu_bartik/
      forcontu_bartik.info.yml
      forcontu_bartik.libraries.yml
      logo.svg
      screenshot.png
      css/
        style.css
```

在外观管理页面，你会在未安装的主题列表中看到新主题。选择安装并设为默认主题。

如果安装成功，访问站点主页时，你会看到应用了一个类似 Bartik 的主题，但修改了页眉背景颜色。

### 主题修改类型

主题设计的修改可以在两个层次上进行：

- **修改模板文件（`.html.twig`）**：
  - 更改现有元素的顺序，包括静态（HTML）和动态（变量）元素。
  - 添加新元素，包括静态（HTML 和 CSS 片段）和动态（允许的变量，如我们将在后续课程中看到的）元素。
  - 删除或隐藏模板中的元素。可以删除或注释部分代码（静态或动态），以便在应用模板时不显示这些元素。

- **修改样式表文件（`.css`）**：
  - 修改模板中现有的样式。
  - 创建新样式，在这种情况下，需要在模板的 HTML 代码中正确引用这些样式。
  - 删除不使用的样式。
### 主题修改和缓存

当我们对主题文件进行修改时，为了使更改生效，可能需要清除浏览器缓存（按 `Control + F5`）以及站点缓存，可以通过以下方式清除站点缓存：

- **管理区域**：
  - 管理 -> 配置 -> 开发 -> 性能
  - `[清空所有缓存]`

- **开发选项**（通过 Admin Toolbar 或 WebProfiler 提供的 Devel 模块）。

- **通过控制台使用 Drush**。

在开发或修改主题期间，建议启用 Devel 模块提供的以下选项（开发选项）：

- 每次页面加载时重建主题注册表。

这样可以避免频繁清空站点缓存。

对于 CSS 文件的修改，我们需要从性能设置中禁用 CSS 文件缓存（禁用“合并 CSS 文件”选项）。

### 添加 CSS 和 JS 文件

可以通过 CSS 样式表修改主题的外观。这不需要编程知识，但需要具备使用 CSS 进行网页布局的知识。在前端课程中，我们将深入学习 HTML 和 CSS。

如前所述，CSS 文件位于主题的 `/css` 文件夹中，并在 `theme_name.libraries.yml` 文件中声明。要修改特定样式，可以修改现有文件或声明并创建一个新的 CSS 文件，并在库中注册。

下面显示了一个 `.libraries.yml` 文件的示例，其中引用了 `css/foo.css` 和 `js/foo.js` 文件。==如果 JavaScript 文件包含 jQuery，==则需要添加对 `core/jquery` 库的依赖，因为 Drupal 8 仅在需要时加载 jQuery。

```yaml
foo:
  version: 1.x
  css:
    theme:
      css/foo.css: {}
  js:
    js/foo.js: {}
  dependencies:
    - core/jquery
```

在主题中，通常会添加一个名为 `global-styling` 的库，该库将在使用该主题的所有页面上加载所有 CSS 文件：

```yaml
global-styling:
  version: 1.x
  css:
    theme:
      css/layout.css: {}
      css/style.css: {}
      css/colors.css: {}
      css/print.css: { media: print }
```

==需要注意的是==，CSS 文件将按指定顺序加载。

有关与主题相关的库加载的更多信息，请访问以下链接：

[向 Drupal 主题添加样式表（CSS）和 JavaScript（JS）](https://www.drupal.org/docs/theming-drupal/adding-stylesheets-css-and-javascript-js-to-a-drupal-theme)

### 使用 CSS 修改样式

可以通过 CSS 样式表修改主题的外观。这不需要编程知识，但需要具备使用 CSS 进行网页布局的知识。在本次 Site Building 课程中，我们不会深入探讨 CSS 布局，将其留待后续的后端开发和前端开发课程中学习。

如前所述，CSS 文件位于主题的 `/css` 文件夹中，并在 `*.libraries.yml` 文件中声明。要修改特定样式，可以修改现有文件或声明并创建一个新的 CSS 文件。

#### 元素检查器

要修改样式，我们需要了解 HTML 结构（标签、属性和类），以便定位到具体的元素。在现代浏览器中，有一个开发者工具——元素检查器，它可以让我们在页面上查看 HTML 内容和应用于该元素的 CSS 类。

在图 中，我们可以看到 Chrome 中的元素检查器的工作方式（右键单击页面上的任何元素，选择“检查”）：
![[Pasted image 20240624101611.png]]
- **A. 当前页面**：突出显示选中的元素。
- **B. HTML**：突出显示在 A 中选中的元素生成的 HTML 代码。
- **C. 应用于该元素的 CSS 样式。

例如，如果我们想更改页面标题的颜色，并且我们有以下 HTML 代码：

```html
<div class="region-header">
  <div class="site-branding__text">
    <div class="site-branding__name">
      <a href="/" title="Inicio" rel="home">Experto en Drupal 10 Site Building</a>
    </div>
  </div>
</div>
```

我们可以通过应用以下 CSS 样式来更改文本颜色：

```css
.region-header .site-branding__text a {
  color: #000;
}
```

或

```css
.region-header .site-branding__name a {
  color: #000;
}
```

但是，我们应该将这些代码添加到哪里呢？

如果查看图中的 C 部分，我们会看到 `color` 属性应用在 `/core/themes/bartik/css/colors.css` 文件中的一个样式中。以下代码突出显示了实际影响标题的样式：

```css
.region-header,
.region-header a,
.region-header li a.is-active,
.site-branding__text,
.site-branding,
.site-branding__text a,
.site-branding a,
.region-secondary-menu .menu-item a,
.region-secondary-menu .menu-item a.is-active {
  color: #fffeff;
}
```

我们已经找到了应用样式的文件和代码，但我们可以直接修改这个文件来更改颜色代码吗？答案是否定的。

我们的主题是 Bartik 的子主题，而 Bartik 是核心主题，`colors.css` 是 Bartik 中包含的文件。如果我们直接修改它，就相当于修改了核心文件，这是绝对不允许的。因为当我们更新 Drupal 时，会丢失所做的更改。

因此，我们必须将代码包含在我们主题的文件中，具体来说是在我们之前创建的 `/themes/forcontu_bartik/css/style.css` 文件中。

下载、编辑并重新上传文件到服务器。考虑到之前的代码，文件将包含以下内容：

```css
#header {
  background-color: #C7D0D6;
  background-image: none;
}

.region-header .site-branding__text a {
  color: #000;
}
```

最后，刷新页面以查看更改（标题变为黑色）[F26.1i]。如果没有更新，请按以下顺序尝试：

1. 更新 Drupal 缓存（从性能设置中）。
2. 更新浏览器缓存（按 `Control + F5`）。

使用浏览器的元素检查器，我们可以看到应用于标题的新 CSS 代码。之前的代码仍然显示，但被划掉，因为 Forcontu Bartik 主题的代码在最后评估，因此优先于基础主题 Bartik 提供的样式 [F26.1j]。
# 26.2 模板文件

### 什么是模板

要理解主题如何工作，首先需要了解模板文件（`*.html.twig`）的工作原理。

模板是一个文本文件，其中混合了静态或固定的 HTML 代码和其他编程片段（在 Twig 中），这些片段包括变量或表达式。当 Drupal 加载网站时，这些变量和表达式将被替换为相应的值，与静态内容一起生成最终的 HTML 代码，显示在浏览器中。

例如，查看以下模板代码：

```html
<h1>{{ title }}</h1>
```

Twig 代码以 `{{` 开始，以 `}}` 结束。在这段代码中，屏幕上显示的是变量 `title` 的内容。该变量用于指示页面的标题，这是一个动态值，取决于当前加载的页面。

假设我们在网站上创建了两页，标题分别为“法律声明”和“关于我们”。应用模板后，每个页面的最终结果将不同，具体如下：

- **页面“法律声明”**：
  ```html
  <h1>法律声明</h1>
  ```

- **页面“关于我们”**：
  ```html
  <h1>关于我们</h1>
  ```

最终生成的代码是带有 HTML 标记的静态代码，也可以包含 CSS（和 JavaScript）。这是发送到用户浏览器以呈现网站和特定页面的代码。浏览器包括一个“查看源代码”选项，可以查看生成的 HTML 代码。

### Twig vs PHPtemplate

Twig 是从 Drupal 8 开始使用的模板引擎。在 Drupal 7 中使用的是基于 PHP 的模板引擎 PHPtemplate。Twig 相对于 PHPtemplate 的优势可以总结为：

- **更高的安全性**：由于不包含 PHP 代码，因此无法直接在模板中添加代码，避免了错误和潜在的安全漏洞。
- **代码整洁**：由于不允许在模板中插入 PHP 代码，代码必须放在相应的位置，即我们开发的模块中。这样，所有的业务逻辑都保留在模块中，而不会分散到模板中。
- **易用性和可扩展性**：正如我们将在后端开发和前端开发课程中看到的，创建和扩展 Twig 格式的模板非常简单。

### 主题的模板结构

理解了模板的概念后，我们将更深入地分析构成 Drupal 主题的每个模板文件：`html.html.twig`、`page.html.twig`、`region.html.twig`、`node.html.twig` 和 `block.html.twig` 等。

Drupal 有自己的默认模板文件，当站点启用的主题没有这些文件时，Drupal 会使用默认模板文件。例如，如果主题不包含 `block.html.twig` 文件，Drupal 在显示块时将使用核心中包含的默认 `block.html.twig` 文件（该文件由核心模块 Block 提供，位于 `/core/modules/block/templates/block.html.twig`）。

因此，如果我们使用的主题没有 `block.html.twig` 文件，但我们想改变块的显示方式，我们需要将默认文件复制到主题的 `templates` 文件夹中，然后进行修改。Drupal 发现主题中有 `block.html.twig` 文件时，将使用该文件而不是核心文件。

每个模板文件提供一个元素的设计。图显示了主要模板文件及其对站点每个元素的影响。
![[Pasted image 20240624103134.png]]
接下来，我们将描述每个文件并查看一些典型的变量。我们将以 Drupal 核心中包含的模板为例。

#### 模板 `html.html.twig`

这是最高级别的模板文件，负责定义 HTML 页面的结构。它负责显示 `<html>`、`<head>` 和 `<body>` 标签等。可以在此模板中使用的一些变量如下：

- **head_title**：用于 `<title>` 标签的页面标题。
- **logged_in**：指示用户是否已登录站点。
- **node_type**：如果页面是一个节点，指示内容类型。
- **page**：已处理并准备在浏览器中显示的页面内容。

如果启用的主题不包含此文件，Drupal 将使用默认文件，位于 `/core/modules/system/templates/html.html.twig`。

```twig
<!DOCTYPE html>
<html{{ html_attributes }}>
  <head>
    <head-placeholder token="{{ placeholder_token|raw }}">
    <title>{{ head_title|safe_join(' | ') }}</title>
    <css-placeholder token="{{ placeholder_token|raw }}">
    <js-placeholder token="{{ placeholder_token|raw }}">
  </head>
  <body{{ attributes }}>
    <a href="#main-content" class="visually-hidden focusable">
      {{ 'Skip to main content'|t }}
    </a>
    {{ page_top }}
    {{ page }}
    {{ page_bottom }}
    <js-bottom-placeholder token="{{ placeholder_token|raw }}">
  </body>
</html>
```
#### 模板 `page.html.twig`

这个模板生成页面中包含的所有代码，并在处理后通过变量 `page` 发送到 `html.html.twig` 模板中。可以使用的一些变量如下：

- **base_path**：Drupal 安装路径。如果安装在域的根目录中，返回“/”。
- **is_front**：指示当前页面是否为站点首页。
- **logged_in**：指示用户是否已登录站点。
- **is_admin**：指示用户是否为站点管理员。
- **front_page**：指向站点首页的链接。
- **$title**：页面标题。
- **messages**：错误或通知消息。
- **node**：节点对象，如果正在加载显示节点的页面。

#### 区域变量

这些变量用于打印每个区域的内容：

- **page.header**
- **page.primary_menu**
- **page.secondary_menu**
- **page.highlighted**
- **page.help**
- **page.content**
- **page.sidebar_first**
- **page.sidebar_second**
- **page.sidebar_footer**
- **page.sidebar_breadcrumb**

如果启用的主题不包含此文件，Drupal 将使用默认文件，位于 `/core/modules/system/templates/page.html.twig`。

以下是 `page.html.twig` 模板的示例代码：

```twig
<div class="layout-container">
  <header role="banner">
    {{ page.header }}
  </header>
  {{ page.primary_menu }}
  {{ page.secondary_menu }}
  {{ page.breadcrumb }}
  {{ page.highlighted }}
  {{ page.help }}
  <main role="main">
    <a id="main-content" tabindex="-1"></a>{# link is in html.html.twig #}
    <div class="layout-content">
      {{ page.content }}
    </div>{# /.layout-content #}
    {% if page.sidebar_first %}
      <aside class="layout-sidebar-first" role="complementary">
        {{ page.sidebar_first }}
      </aside>
    {% endif %}
    {% if page.sidebar_second %}
      <aside class="layout-sidebar-second" role="complementary">
        {{ page.sidebar_second }}
      </aside>
    {% endif %}
  </main>
  {% if page.footer %}
    <footer role="contentinfo">
      {{ page.footer }}
    </footer>
  {% endif %}
</div>
```

这个模板定义了页面的主要布局结构，包括页眉、主菜单、次菜单、面包屑导航、高亮区域、帮助区域、主要内容区域、侧边栏和页脚。每个区域都使用相应的变量来打印其内容。

#### 模板 `block.html.twig`

这个模板用于生成页面中块的展示。可以使用的一些变量如下：

- **plugin_id**：块实现的内部 ID。
- **label**：块的标题。
- **content**：块的内容。
- **attributes**：与块关联的 HTML 属性，例如 `id` 或 `class`。
- **title_attributes**：与块标题关联的 HTML 属性。
- **title_prefix** 和 **title_suffix**：标题的前缀和后缀。

如果启用的主题不包含此文件，Drupal 将使用默认文件，位于 `/core/modules/block/templates/block.html.twig`。

以下是 `block.html.twig` 模板的示例代码：

```twig
<article{{ attributes }}>
  {{ title_prefix }}
  {% if not page %}
    <h2{{ title_attributes }}>
      <a href="{{ url }}" rel="bookmark">{{ label }}</a>
    </h2>
  {% endif %}
  {{ title_suffix }}
  {% if display_submitted %}
    <footer>
      {{ author_picture }}
      <div{{ author_attributes }}>
        {% trans %}Submitted by {{ author_name }} on {{ date }}{% endtrans %}
        {{ metadata }}
      </div>
    </footer>
  {% endif %}
  <div{{ content_attributes }}>
    {{ content }}
  </div>
</article>
```

#### 其他模板文件

还有许多其他模板文件负责站点的其他区域。其他模板文件的示例包括：

- **`region.html.twig`**：生成主题中任何区域的展示。此模板的默认文件位于 `/core/modules/system/templates/region.html.twig`。
- **`comment.html.twig`**：显示站点评论的输出。此模板的默认文件位于 `/core/modules/comment/templates/comment.html.twig`。
- **`maintenance-page.html.twig`**：显示站点维护页面的输出。此模板的默认文件位于 `/core/modules/system/templates/maintenance-page.html.twig`。

此外，模块也可以有自己的模板文件。例如，Forum 模块包含多个模板文件，用于配置论坛消息的显示（`forums.html.twig`、`forum-list.html.twig` 等）。每个模块可以包含多个模板文件，并从其自身的代码中使用这些文件来显示其添加到站点的新工具。

如果我们想修改任何这些模板文件，绝不应直接在模块的文件中进行修改。首先，我们应将文件复制到主题的 `templates` 文件夹中，然后修改该文件，而不更改其原始名称。

### 模板调试

在开发过程中，确定哪个模板负责生成特定的 HTML 输出是一个主要的挑战。为了简化这一任务，Twig 提供了一个调试选项，我们只在开发站点时启用它：

1. 找到文件 `sites/default/services.yml`。如果文件不存在，复制 `default.services.yml`（在同一文件夹中），并将其重命名为 `services.yml`。注意，默认文件夹和 `services.yml` 文件是只读的，因此你需要更改权限才能复制和编辑 `settings.yml` 文件。你可以将权限更改为 777，进行更改，然后让系统恢复原始权限。

2. 在 `twig.config` 部分，将 `debug` 的值更改为 `true`。
    ```yaml
    parameters:
      twig.config:
        debug: true
    ```

3. 清空站点缓存。

4. 访问状态报告。这一步恢复默认文件夹的原始权限。

5. 不要忘记在生产环境中禁用此选项。

调试信息将作为 HTML 注释显示在生成的页面源代码中。例如，在 Chrome 中，我们可以使用“查看页面源代码”或“检查”选项。

每个模板以标签 `<!-- THEME DEBUG -->` 开始，并包含以下调试信息：

- ==**THEME HOOK**：引用使用的基础模板。==例如，如果值是 `field`，基础模板将是 `field.html.twig`。
- **FILE NAME SUGGESTIONS**：稍后我们将看到模板建议（或模板名称建议）。同一个模板可以有不同的名称，以便更具体地作用。例如：
  - `html.html.twig`：通用模板，适用于所有页面。
  - `html--front.html.twig`：更具体的模板，适用于站点首页（front）。

  当存在两个模板时，应用更具体的模板。实际上，列表已经按优先级顺序排列。在模板名称建议列表中，当前页面正在使用的模板以 `x` 标记。

- **BEGIN/END OUTPUT**：标记模板返回的 HTML 输出的开始和结束。在开始和结束处，指示使用的模板文件的完整路径。请注意，模板可以包含其他模板。

#### 示例 1：文件开头，引用最高级别的 `html` 模板。此模板在文件末尾关闭。

```html
<!-- THEME DEBUG -->
<!-- THEME HOOK: 'html' -->
<!-- FILE NAME SUGGESTIONS:
 * html--front.html.twig
 * html--.html.twig
 x html.html.twig
-->
<!-- BEGIN OUTPUT from 'core/themes/classy/templates/layout/html.html.twig' -->
<!DOCTYPE html>
<html lang="es" ...>
  <head>
  ...
  </body>
</html>
<!-- END OUTPUT from 'core/themes/classy/templates/layout/html.html.twig' -->
```

#### 示例 2：应用于内容标题的模板。在这种情况下，使用的是 `field--node--title.html.twig` 模板，这是一个专门用于节点标题的模板。

```html
<!-- THEME DEBUG -->
<!-- THEME HOOK: 'field' -->
<!-- FILE NAME SUGGESTIONS:
 * field--node--title--article.html.twig
 x field--node--title.html.twig
 * field--node--article.html.twig
 * field--title.html.twig
 * field--string.html.twig
 * field.html.twig
-->
<!-- BEGIN OUTPUT from 'core/themes/classy/templates/field/field--node--title.html.twig' -->
<span property="schema:name" data-quickedit-field-id="node/9/title/es/teaser"
class="field field--name-title field--type-string field--label-hidden">Adipiscing Nimis Proprius</span>
<!-- END OUTPUT from 'core/themes/classy/templates/field/field--node--title.html.twig' -->
```

如果我们想修改显示节点标题的模板（示例 2），首先需要找到它的位置。在这个例子中，模板位于核心主题 `classy` 中，因此我们不能直接修改它。我们需要将该模板复制到我们主题的 `templates` 文件夹中。

一旦模板在我们的主题中，刷新页面并检查文件路径是否符合预期。如果没有看到更改，清空缓存。显示的其他信息完全相同，因为模板名称保持不变，但位置在我们的主题中。现在我们可以修改模板了。

```html
<!-- THEME DEBUG -->
<!-- THEME HOOK: 'field' -->
<!-- FILE NAME SUGGESTIONS:
 * field--node--title--article.html.twig
 x field--node--title.html.twig
 * field--node--article.html.twig
 * field--title.html.twig
 * field--string.html.twig
 * field.html.twig
-->
<!-- BEGIN OUTPUT from 'themes/forcontu_bartik/templates/field--node--title.html.twig' -->
<span property="schema:name" data-quickedit-field-id="node/9/title/es/teaser"
class="field field--name-title field--type-string field--label-hidden">Adipiscing Nimis Proprius</span>
<!-- END OUTPUT from 'themes/forcontu_bartik/templates/field--node--title.html.twig' -->
```

### `dump()` 函数

==启用 Twig 调试后，==我们还可以在模板中使用 `dump()` 函数。

- `{{ dump(variable) }}`：显示指定变量的值。
- `{{ dump() }}`：显示模板中所有可用变量及其对应的值。

如果安装了 Devel Kint 模块（包含在 Devel 中），可以使用 `kint()` 函数，它改进了结果的显示。

- `{{ kint(variable) }}`：显示指定变量的值。
- `{{ kint() }}`：显示模板中所有可用变量及其对应的值。

无论是在 PHP 还是 Twig 中，都推荐使用 Kint。
### 模板建议（Template Suggestions）

我们已经提到过，为了修改模板，首先需要将其复制到我们的主题中。在很多情况下，我们不希望对所有使用该模板的情况进行更改，而只希望对特定情况进行更改。

例如，我们可能只需要修改搜索块（`search` 模块的系统名称为 `form-block`）的块模板（`block.html.twig`）。在这种情况下，我们可以复制基础模板 `block.html.twig` 并更改名称以使其更具体：`block--search-form-block.html.twig`。

如果你在调试注释中定位到块的输出，这并不复杂。在这种情况下，我们看到 `bartik` 已经实现了一个特定的搜索块模板，位于：

- `core/themes/bartik/templates/block--search-form-block.html.twig`

要修改它，我们将这个模板复制到我们的主题中，而无需更改文件名。

```html
<!-- THEME DEBUG -->
<!-- THEME HOOK: 'block' -->
<!-- FILE NAME SUGGESTIONS:
 * block--b-forcontu-formulariodebusqueda.html.twig
 x block--search-form-block.html.twig
 * block--search.html.twig
 * block.html.twig
-->
<!-- BEGIN OUTPUT from 'core/themes/bartik/templates/block--search-form-block.html.twig' -->
<div class="search-block-form contextual-region block block-search container-inline" data-drupal-selector="search-block-form" id="block-b-forcontu-formulariodebusqueda" role="search">
  <h2>Formulario de búsqueda</h2>
</div>
```

#### 更多示例：

- **`page--node--1.html.twig`**：仅在加载 nid 为 1 的节点时影响 `page` 模板。
- **`page--node.html.twig`**：当加载的页面是一个节点时的 `page` 模板。
- **`block--module-delta.html.twig`**：影响模块 `module` 中定义的内部名称为 `delta` 的块。正如我们之前看到的，`block--search-form-block.html.twig` 模板遵循这个模式。
- **`node--type.html.twig`**：影响所有特定类型的节点。例如，`node--article.html.twig` 影响所有类型为文章的节点。

你可以在 [Drupal 官方文档](https://www.drupal.org/node/2354645) 中查看其他可能的组合。

### 自定义模板建议

通过 `hook_theme_suggestions_alter()` 我们可以添加新的模板名称建议，这些建议将根据特定条件起作用。

```php
hook_theme_suggestions_alter(array &$suggestions, array $variables, $hook)
```

[API 文档](https://api.drupal.org/api/drupal/core!lib!Drupal!Core!Render!theme.api.php/function/hook_theme_suggestions_alter/10)

作为替代方案，如果我们要针对特定的 HOOK 操作，可以使用以下函数：

```php
hook_theme_suggestions_HOOK_alter(array &$suggestions, array $variables)
```

[API 文档](https://api.drupal.org/api/drupal/core!lib!Drupal!Core!Render!theme.api.php/function/hook_theme_suggestions_HOOK_alter/10)

这个 hook 可以在模块和主题中实现。要在主题中实现它，首先在根文件夹中创建一个 `nombre_tema.theme` 文件。`.theme` 文件是一个 PHP 文件，我们可以在其中为主题添加编程功能。

例如，我们将为节点（HOOK = node）添加一些特定的模板建议，这些建议将作为 `node.html.twig` 模板的替代方案。

- **`node--type--logged-in.html.twig`**：当用户已登录时，特定类型节点的模板。
- **`node--logged-in.html.twig`**：当用户已登录时，任何节点的模板。

```php
<?php
/**
 * @file
 * Functions to support theming in the Bartik Forcontu theme.
 */

/**
 * Implements hook_theme_suggestions_HOOK_alter() for HOOK 'node'.
 */
function forcontu_bartik_theme_suggestions_node_alter(array &$suggestions, array $variables) {
  if (\Drupal::currentUser()->isAuthenticated()) {
    $suggestions[] = 'node__' . 'logged_in';

    $node = $variables['elements']['#node'];
    if ($node->getType()) {
      $suggestions[] = 'node__' . $node->getType() . '__logged_in';
    }
  }
}
```

新的建议将添加到现有的建议中，并以相同的方式使用，即将基础模板复制到我们的主题中（或当前正在使用的模板），并将文件名更改为建议的名称。

```html
<!-- THEME DEBUG -->
<!-- THEME HOOK: 'node' -->
<!-- FILE NAME SUGGESTIONS:
 * node--article--logged-in.html.twig
 * node--logged-in.html.twig
 * node--9--full.html.twig
 * node--8.html.twig
 * node--article--full.html.twig
 * node--article.html.twig
 * node--full.html.twig
 x node.html.twig
-->
<!-- BEGIN OUTPUT from 'core/themes/bartik/templates/node.html.twig' -->
```

#### ==注意事项==：
![[Pasted image 20240624105606.png]]
- 数组 `$suggestions` 是通过引用传递的，因此我们可以修改或删除现有的建议。
- 数组 `$suggestions` 中的元素按从低到高的特异性排序，这与调试代码中显示的顺序相反。通常，只需将我们的建议添加到数组的末尾即可。如果添加多个建议，则需要按适当的顺序添加，从低到高的特异性。
# 26.3 Drupal 中的 Twig

如前所述，在模板中，Twig 代码与 HTML 代码混合在一起，以生成最终发送到浏览器的 HTML 代码。在第 10.5 节中，我们已经对 Twig 进行了简要介绍，现在我们将其适应于 Drupal 中的使用。

要了解本节内容的更多信息，建议参考以下链接：

- [Twig 官方文档](https://twig.symfony.com/doc/3.x/)
- [Twig 编码标准](https://twig.symfony.com/doc/3.x/coding_standards.html)
- [Drupal 中的 Twig 编码标准](https://www.drupal.org/node/1823416)

### 注释

要在代码中编写注释，我们使用 `{# #}`。如果注释只有一行，开头和结尾在同一行。如果注释有多行，我们将其分开。注释行应尽量少于 80 个字符。

```twig
{# 单行注释 #}
{#
 多行注释
 注意：所有这些代码都是注释，不会执行。
 变量也不会在其中执行，例如 {{ title }}
#}
```

### DocBlock

DocBlock 是放置在模板文件开头的文档块。它是一个注释块，因此用 `{#` 和 `#}` 包围。

==模板文件使用 `@file` 指令进行注释==，并列出可用变量（Available variables），这些变量由预处理函数发送，并通过 `@see` 指令引用。例如：

```twig
{#
/**
 * @file
 * Default theme implementation to present a feed item in an aggregator page.
 *
 * Available variables:
 * - url: URL to the originating feed item.
 * - title: Title of the feed item.
 * - content: All field items. Use {{ content }} to print them all,
 *   or print a subset such as {{ content.field_example }}. Use
 *   {{ content|without('field_example') }} to temporarily suppress the printing
 *   of a given element.
 * - attributes: HTML attributes for the wrapper.
 * - title_prefix: Additional output populated by modules, intended to be
 *   displayed in front of the main title tag that appears in the template.
 * - title_suffix: Additional output populated by modules, intended to be
 *   displayed after the main title tag that appears in the template.
 *
 * @see template_preprocess_aggregator_item()
 *
 * @ingroup themeable
 */
#}
<article{{ attributes }}>
  {{ title_prefix }}
  <h3>
    <a href="{{ url }}">{{ title }}</a>
  </h3>
  {{ title_suffix }}
  {{ content }}
</article>
```

要查看其他实际编码示例，建议直接分析 Drupal 核心文件和其他贡献模块的文件。

指令 `@ingroup themeable` 表示模板在 `themeable` 组内。此指令仅包含在默认模板中，==因此在我们主题中覆盖模板时不应包含它。==

### 变量

##### 打印变量

要打印变量的值，将其放在双大括号 `{{ }}` 中。以下是一些示例：

a) 简单变量示例：

```twig
{{ title }}
```

b) 带属性的变量（来自 PHP ==对象==）：

```twig
{{ foo.bar }}
```

c) 带元素的变量（来自 PHP ==数组==）：

```twig
{{ foo['bar'] }}
```

d) ==如果属性名称包含特殊字符==（例如连字符 - 可能被解释为减号），可以使用 `attribute()` 函数：

```twig
{{ attribute(foo, 'data-bar') }}
```

==这相当于显示== `foo.data-bar` 的值。

##### 检查变量

==这是 Drupal 中非常典型的表达式==。在打印变量之前，我们检查变量是否已定义并具有值。包含变量的 HTML 代码也包含在 `if` 语句中。

不需要使用 `is defined` 过滤器来检查变量是否可用。

```twig
{% if foo %}
  <div>{{ foo }}</div>
{% endif %}
```

##### 赋值变量

Twig 允许我们在模板中使用辅助变量。我们使用 `set` 标签，在 `{%` 和 `%}` 之间（而不是 `{{ }}`）。

```twig
{% set foo = 'bar' %}
{% set foo = [1, 2] %}
```

这些辅助变量可以打印或用于其他表达式。

##### 全局变量

在所有模板中都可以使用以下==全局变量==：

- **`_self`**：返回一个 `Twig_Template` 类型的对象，包含当前模板的信息。可用的方法可以在 [API 文档](https://api.drupal.org/api/drupal/vendor!twig!twig!lib!Twig!Template.php/class/Twig_Template/10) 中查看。记住可以使用调试函数 `dump()` 和 `kint()` 查看任何变量的结构和内容。如果直接打印变量 `{{ _self }}`，它会返回当前模板文件的路径和名称，从站点根目录开始。例如：

  ```twig
  themes/forcontu_bartik/templates/node--article.html.twig
  ```

- **`_context`**：这是一个包含当前上下文信息的数组，如模板中可用的所有变量。除了传递给模板的变量外，还显示在模板中定义的变量。

  ```twig
  {{ dump(context) }} // 等同于 {{ dump() }}。也可以使用 kint()。
  ```

- **`_charset`**：字符集（例如 "UTF-8"）。
### 过滤器

过滤器用于以某种方式修改变量。例如，一个过滤器可以将字符串转换为大写（`upper`）。

要对变量使用过滤器，首先写出要应用过滤器的变量，然后是用管道符号 `|` 分隔的过滤器名称。可以将多个过滤器连接在一起，用 `|` 分隔，它们将按顺序应用于变量。

```twig
{% set foo = 'welcome' %}
{{ foo|upper }}
{# 输出将是：WELCOME #}
{{ 'welcome'|upper }}
{# 也可以直接对字符串使用过滤器，得到相同的结果 #}
```

==过滤器也可以应用于一段代码==，结构如下：

```twig
{% filter upper %}
 这个文本将转换为大写
{% endfilter %}
```

==一些可用的过滤器包括：==

- **upper**：将字符串中的所有字母转换为大写。
  ```twig
  {{ 'welcome'|upper }}
  {# 结果：WELCOME #}
  ```

- **lower**：将字符串中的所有字母转换为小写。
  ```twig
  {{ 'WELCOME'|lower }}
  {# 结果：welcome #}
  ```

- **capitalize**：将字符串的第一个字母转换为大写。
  ```twig
  {{ 'welcome home'|capitalize }}
  {# 结果：Welcome home #}
  ```

- **title**：将字符串中每个单词的第一个字母转换为大写。
  ```twig
  {{ 'welcome home'|title }}
  {# 结果：Welcome Home #}
  ```

- **date**：允许格式化日期。其工作方式类似于 PHP 的 `date` 函数。
  ```twig
  {{ "now"|date("d/m/Y") }}
  {# 结果：13/02/2016 #}
  ```

- **join**：将数组的元素连接成一个字符串。默认情况下使用空字符串作为分隔符（无分隔），但可以指定任何其他字符。
  ```twig
  {{ [1, 2, 3]|join }}
  {# 结果：123 #}
  {{ [1, 2, 3]|join(',') }}
  {# 结果：1,2,3 #}
  ```

- **sort**：对数组进行排序。
  ```twig
  {% set foo = [3, 2, 4, 1]|sort %}
  {# 变量 foo 的内容将是：[1, 2, 3, 4] #}
  ```

- **length**：返回数组的元素数量或字符串的字符数。
  ```twig
  {% set count = users|length %}
  {# 将用户数量存储在变量 count 中 #}
  ```

完整的 Twig 过滤器列表可以在 [Twig 官方文档](https://twig.symfony.com/doc/3.x/filters/index.html) 中查看。

### Drupal 特定的过滤器

除了 Twig 自带的过滤器，Drupal 还包含一些额外的过滤器，可以在 [Drupal 文档](https://www.drupal.org/docs/theming-drupal/twig-in-drupal/filters-modifying-variables-in-twig-templates) 中查看。这些过滤器在 `TwigExtension::getFilters()` 中声明：

[API 文档](https://api.drupal.org/api/drupal/core!lib!Drupal!Core!Template!TwigExtension.php/function/TwigExtension::getFilters/10)

- **trans (或 t)**：用于从模板中翻译字符串。与模块代码中直接包含的所有文本一样，模板中添加的文本也应通过翻译函数 `t()`。

  当处理简单字符串（无替换模式）时，我们使用过滤器 `|t`。

  ```twig
  <a href="{{ url('<front>') }}" title="{{ 'Home'|t }}" rel="home" class="sitelogo"></a>
  <h2>{{ 'Book traversal links for'|t }} {{ book_title }}</h2>
  <b>{{ 'Not triggered'|t }}</b>
  ```

  ==当字符串包含变量或替换模式时，==我们使用过滤器 `{% trans %}`：

  ```twig
  {% trans %}
    Submitted by {{ author_name }} on {{ date }}
  {% endtrans %}
  {% trans %}Submitted by {{ author_name }} on {{ date }}{% endtrans %}
  {% trans %}
    This {{ token.name }} has a length of: {{ count }}. It contains: {{
    token.numbers|placeholder }} and {{ token.bad_text }}.
  {% endtrans %}
  ```

- **placeholder**：返回强调文本（`<em></em>`）。也会进行 HTML 转义，将某些特殊字符转换为其 HTML 对应字符。

  ```twig
  {% set temp = 'The value is < 5' %}
  {{ temp|placeholder }}
  ```

  输出：
  ```html
  <em class="placeholder">The value is &lt; 5</em>
  ```

### 控制结构

##### 控制结构：for

`for` 可以像 `foreach` 一样使用：

```twig
<h1>Users</h1>
<ul>
  {% for user in users %}
    <li>{{ user.name }}</li>
  {% endfor %}
</ul>
```

输出一个包含用户名（属性 `name`）的 HTML 列表：

```html
<h1>Users</h1>
<ul>
  <li>frangil</li>
  <li>laurafornie</li>
  <li>userfoo</li>
</ul>
```

==如果需要同时使用键和值==，等同于 `foreach` 的写法是：

```twig
{% for value, key in items %}
  <div class="{{ key }}">{{ value }}</div>
{% endfor %}
```

我们也可以像经典的 `for` 循环一样使用它，设置一个执行范围：

```twig
{% for i in range(0, 3) %}
  {{ i }},
{% endfor %}
```

输出：`0, 1, 2, 3`

##### 控制结构：if

允许评估一个条件以执行或不执行一组操作。

```twig
{% if title|length > 0 %}
  <h1>{{ title }}</h1>
{% endif %}
```

仅当变量 `title` 不为空时，输出标题值（及 `h1` 标签）。

### 函数

Twig 提供了一组可以在模板中使用的函数。例如，`range` 函数，我们已经在前面的 `for` 结构中使用过，它返回一个从最小值到最大值的数字列表。还可以设置值之间的==步长==（第三个参数）。

```twig
{% for i in range(0, 6, 2) %}
  {{ i }},
{% endfor %}
```

输出：`0, 2, 4, 6`

`max` 函数返回提供的值中的最大值。

```twig
{{ max(1, 3, 2) }}
```

输出：`3`

可以在 [Twig 官方文档](https://twig.symfony.com/doc/2.x/functions/index.html) 中查看默认可用的完整函数集。

### Drupal 特定的函数

除了 Twig 自带的函数，Drupal 还包含一些额外的函数，可以在 [Drupal 文档](https://www.drupal.org/docs/theming-drupal/twig-in-drupal/functions-in-twig-templates) 中查看。

##### url() 和 path()

==给定一个路由名称及其参数，这两个函数生成相应的 URL。==唯一的区别是 `url()` 生成绝对 URL，而 `path()` 生成相对 URL。路由必须预先在 `.routing.yml` 文件中定义。

函数所需的参数是：

```php
url($name, $parameters, $options)
path($name, $parameters, $options)
```

一些示例：

a) 指向主页的绝对 URL：

```twig
<a href="{{ url('<front>') }}">{{ 'Home'|t }}</a>
```

生成的 HTML 代码：

```html
<a href="http://www.example.com/">Inicio</a>
```

b) 指向主页的相对 URL：

```twig
<a href="{{ path('<front>') }}">{{ 'Home'|t }}</a>
```

生成的 HTML 代码：

```html
<a href="/">Inicio</a>
```

c) 指向 `forcontu_pages.simple` 路由（在 Forcontu Pages 模块中定义）的相对 URL：

```twig
<a href="{{ path('forcontu_pages.simple') }}">{{ 'Forcontu Simple Page'|t }}</a>
```

d) 指向用户个人资料页面的相对 URL：

```twig
<a href="{{ path('entity.user.canonical', {'user': user.id}) }}">{{ 'View user profile'|t }}</a>
```

e) 指向节点的相对 URL：

```twig
<a href="{{ path('entity.node.canonical', {'node': node.id}) }}">{{ 'View node page'|t }}</a>
```

##### link()

`link()` 函数生成完整的链接代码，参数包括链接文本、URL 和将添加到 `<a>` 标签的附加属性。

需要注意的是，URL 不对应于 `url()` 和 `path()` 函数获得的字符串，而==必须是 `\Drupal\Core\Url` 类型的对象==。

```twig
{% for item in items %}
  <li{{ item.attributes }}>
    {{ link(item.title, item.url, {'class':['foo', 'bar']}) }}
  </li>
{% endfor %}
```

#### attach_library($library)

==将一个库附加到模板中==。

```twig
{{ attach_library('classy/node') }}
```

### 命名参数

==在函数调用中，==Twig 允许我们指定每个参数的名称，如下所示：

```twig
{% for i in range(low=1, high=10, step=2) %}
  {{ i }},
{% endfor %}
```

参数名称是函数声明中定义的名称。

命名参数相对于位置参数的优点包括：

- **提高代码可读性**：可以在不查阅函数 API 的情况下了解每个参数的含义。
- **跳过函数调用中的参数**：未设置的参数将使用==默认值==。
- **重新排列传递给函数的参数**：由于参数是命名的，传递给函数的==顺序==无关紧要。

我们还可以在函数调用中混合使用位置参数和命名参数。在这种情况下，总是将位置参数放在前面，并按函数预期的顺序排列。

### 模板继承：block、extends、parent()

Twig 最强大的功能之一是可以从其他模板继承。在“父”模板或基础模板中，可以通过 `block` 标签定义块，这些块将是子模板可以修改的片段。

让我们看一个例子。首先定义一个名为 `base.html.twig` 的基础模板 [F26.3a]。这个模板将作为第一级模板，包含 HTML 页面的一些典型元素（`<html>`、`<head>` 和 `<body>` 标签）。

在这个模板中定义了几个块：

- **block head**：文档的 `<head>` 部分的内容。在基础头部中添加了一个 CSS 样式表 `css/style.css`。
- **block title**：这个块在 `head` 块中，用于打印当前页面的 `title` 属性。这个块是空的，将由子模板填充。
- **block content**：内容块。在基础模板中，这个块是完全空的，将由子模板填充。
- **block footer**：页脚块，包含版权文本。

```twig
{# 文件 base.html.twig #}
<!DOCTYPE html>
<html>
  <head>
    {% block head %}
      <link rel="stylesheet" href="css/style.css" />
      <title>{% block title %}{% endblock %} - Forcontu</title>
    {% endblock %}
  </head>
  <body>
    <div id="content">{% block content %}{% endblock %}</div>
    <div id="footer">
      {% block footer %}
        &copy; Copyright 2017 by
        <a href="https://www.forcontu.com">Forcontu</a>.
      {% endblock %}
    </div>
  </body>
</html>
```

现在我们创建一个继承自上述模板的模板，填充信息或在块中添加额外信息 [F26.3b]。

```twig
{# 文件 content.html.twig #}
{% extends "base.html.twig" %}
{% block title %}{{ title }}{% endblock %}
{% block head %}
  {{ parent() }}
  <link rel="stylesheet" href="css/custom.css" />
{% endblock %}
{% block content %}
  <h1>{{ title }}</h1>
  <div>{{ content }}</div>
{% endblock %}
```

- **block title**：传递变量 `{{ title }}` 的值。
- **block head**：首先调用 `parent()` 函数，重用基础模板中该块的所有内容。然后添加对另一个样式表的引用。
- **block content**：使用 HTML 和变量 `title` 和 `content` 填充内容块。当然，系统必须确保这些变量传递到模板中。
- **block footer**：没有引用，因此将使用基础模板中的块。

处理模板及其相应变量后的最终 HTML 如下所示 [F26.3c]：

```html
<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="css/style.css" />
    <title>Home - Forcontu</title>
    <link rel="stylesheet" href="css/custom.css" />
  </head>
  <body>
    <div id="content">
      <h1>Home</h1>
      <div>Contenido de la página</div>
    </div>
    <div id="footer">
      &copy; Copyright 2017 by
      <a href="http://www.forcontu.com">Forcontu</a>.
    </div>
  </body>
</html>
```

### 表达式

最后，我们来看一些可以在 Twig 中使用的表达式、变量类型和操作符：

#### 数组

数组用方括号 `[]` 表示，元素之间用逗号分隔。

```twig
["foo", "bar", "barz"]
```

关联数组用花括号 `{}` 表示，元素为键值对。当键是字符串时，可以用单引号括起来或不加引号：

```twig
{ 'foo':'foo', 'bar':'bar' }
{ foo:'foo', bar:'bar' }
```

键也可以是数字：

```twig
{ 2: 'foo', 4: 'bar' }
```

键也可以是表达式，必须用括号括起来：

```twig
{ (1 + 1): 'foo', (a ~ 'b'): 'bar' }
```

#### 数学运算

除了常见的运算符 `+`、`-`、`/`、`%`（取余）和 `*`，我们还可以使用以下运算符：

- `//`：将两个数相除并返回整数部分。
- `**`：==幂运算==。`{{ 2 ** 3 }}` 表示 2 的 3 次方，结果是 8。

#### 逻辑运算符

可用的逻辑运算符有 `and`、`or` 和 `not`。括号用于分组表达式（`expr`）。

#### ==比较运算符==

除了基本的比较运算符 `==`、`!=`、`<`、`>`、`>=` 和 `<=`，我们还可以使用以下运算符：

- `starts with` 和 `ends with`：检查字符串是否以另一字符串开头或结尾。

```twig
{% if 'foo' starts with 'f' %}
{% endif %}
{% if 'foo' ends with 'o' %}
{% endif %}
```

#### `in` ==运算符==

`in` 运算符检查一个元素是否==包含在数组或字符串==中。也可以使用 `not in` 来检查元素不在列表中。当条件满足时，返回 `true`。

```twig
{% if 1 in [1, 2, 3] %}
{% if 5 not in [1, 2, 3] %}
{% if 'cd' in 'abcde' %}
```

#### `is` 运算符

`is` 运算符检查变量是否满足某个表达式。它被称为测试运算符，测试是与变量比较的表达式。也可以使用 `is not` 进行否定。

```twig
{% if value is odd %}
{% if post.status is constant('Post::PUBLISHED') %}
{% if post.status is not constant('Post::PUBLISHED') %}
```

#### `..` ==运算符==

相当于 `range()` 函数，创建一个从最小值到最大值的序列。

```twig
{{ 1..5 }}
{{ range(1, 5) }}
```

结合 `..` 运算符和 `join` 过滤器，可以得到一个用指定分隔符分隔的字符串：

```twig
{{ (1..5)|join(', ') }}
{# 输出：1, 2, 3, 4, 5 #}
```

#### `~` ==运算符==

将所有操作数转换为字符串并连接起来。

```twig
{% set name = 'Fran' %}
{{ "Hello, " ~ name ~ "!" }}
{# 输出：Hello, Fran! #}
```

#### 三元运算符

==三元运算符==（`A ? B : C`）的工作方式与 PHP 相同。评估表达式 `A`，如果结果为 `true`，返回 `B`，如果为 `false`，返回 `C`。

```twig
{{ foo ? 'yes' : 'no' }}
```

==其他变体==：

```twig
{{ foo ?: 'no' }} 等同于 {{ foo ? foo : 'no' }}
{{ foo ? 'yes' }} 等同于 {{ foo ? 'yes' : '' }}
```

#### `spaceless` ==标签==

`spaceless` 标签删除 HTML 标签之间的空格和换行符，但保留字符串中的空格。

```twig
{% spaceless %}
  <div>
    <strong>foo bar</strong>
  </div>
{% endspaceless %}
{# 输出：<div><strong>foo bar</strong></div> #}
```

#### HTML 属性

在 Drupal 中，许多模板接收变量 `{{ attributes }}`，包含要添加到标签中的 HTML 属性。我们可以一次性打印所有属性，使用 `{{ attributes }}`，或单独访问 `attributes` 中的元素，如 `{{ attributes.id }}`、`{{ attributes.class }}` 等。

```twig
<div id="{{ attributes.id }}" class="{{ attributes.class }}"{{ attributes }}>
  {{ content }}
</div>
```

注意，在示例中，尽管我们单独使用了属性，但在标签的末尾再次添加了 `{{ attributes }}`，以便打印可能来自任何模块的其他属性。
# 26.4 模板预处理函数

正如我们所知，模板接收一系列变量。在这些变量最终到达模板之前，有一系列称为预处理的函数可以拦截并修改它们。

预处理函数的执行顺序如下：

#### 核心：

1. **template_preprocess(&$variables, $hook)**：创建一组默认变量，可供所有钩子使用。
2. **template_preprocess_HOOK(&$variables)**：此函数通常位于注册模板的模块中。例如，Comment 模块添加了 `template_preprocess_comment()` 函数来定义 `comment.html.twig` 模板的变量。
   [API 文档](https://api.drupal.org/api/drupal/core!modules!comment!comment.module/function/template_preprocess_comment/10)

#### ==模块==：

3. **MODULE_preprocess(&$variables, $hook)**：这是模块中 `hook_preprocess()` 的实现。==此函数将被调用以处理所有模板==。
4. **MODULE_preprocess_HOOK(&$variables)**：这是模块中 `hook_preprocess_HOOK()` 的实现。当一个模块希望修改另一个模块的 HOOK 模板变量时使用此函数。

#### 主题引擎（phptemplate）：

5. **ENGINE_engine_preprocess(&$variables, $hook)**：此函数仅应由主题引擎实现。
6. **ENGINE_engine_preprocess_HOOK(&$variables)**：此函数仅应由主题引擎实现。

#### 主题：

7. **THEME_preprocess(&$variables, $hook)**：这是主题中 `hook_preprocess()` 的实现。它在主题的 `.theme` 文件中实现。
8. **THEME_preprocess_HOOK(&$variables)**：这是主题中 `hook_preprocess_HOOK()` 的实现。它在主题的 `.theme` 文件中实现，并作用于特定的 HOOK 模板。

需要注意的是，多个模块可以在同一个 HOOK 上实现预处理函数。它们的执行顺序取决于模块的执行顺序。

==由于最后执行的是主题中实现的函数==，因此主题总是对变量处理有最终决定权。

我们将实现以下函数：

- **hook_preprocess(&$variables, $hook)**
  [API 文档](https://api.drupal.org/api/drupal/core!lib!Drupal!Core!Render!theme.api.php/function/hook_preprocess/10)
- **hook_preprocess_HOOK(&$variables)**
  [API 文档](https://api.drupal.org/api/drupal/core!lib!Drupal!Core!Render!theme.api.php/function/hook_preprocess_HOOK/10)

注意，参数 `$variables` 是通过引用传递给函数的 `&$variables`，这样我们在函数内部所做的更改也将在外部可用，并且变量可以被其他函数重用。

#### 示例 1：

我们将实现 `hook_preprocess_THEME` 来为 `comment.html.twig` 模板添加一个额外的 CSS 类。

在 `forcontu_bartik.theme` 文件中实现函数：

```php
<?php
/**
 * Implements hook_preprocess_HOOK() for comment.html.twig.
 */
function forcontu_bartik_preprocess_comment(&$variables) {
  $variables['attributes']['class'][] = 'forcontu';
}
```

要测试其功能，请在站点的某个节点上创建一个评论。检查生成的源代码，确保添加了 `forcontu` 类。

```html
<!-- BEGIN OUTPUT from 'core/themes/bartik/templates/comment.html.twig' -->
<article role="article" data-quickedit-entity-id="comment/14" data-comment-userid="1" about="/comment/14" typeof="schema:Comment" class="forcontu comment jscomment clearfix">
  <span class="hidden" data-comment-timestamp="1487699815"></span>
```

在这种情况下，我们不需要修改 `comment.html.twig` 模板，也不需要将其添加到我们的主题中，因为我们修改了模板中已经使用的变量。

#### 示例 2：

Drupal 的服务容器包括由 `\Drupal\Core\Template\TwigEnvironment` 类管理的 `twig` 服务：
[API 文档](https://api.drupal.org/api/drupal/core!lib!Drupal!Core!Template!TwigEnvironment.php/class/TwigEnvironment/10)

`isDebug()` 方法在 Twig 调试模式启用时返回 `true`，否则返回 `false`。

在此示例中，我们将添加一个名为 `twig_debug` 的新变量，该变量将在所有模板中可用，并指示调试模式是否已启用。

在我们的主题中实现 `hook_preprocess()` 函数，并调用 `twig` 服务。

```php
<?php
/**
 * Implements hook_preprocess().
 */
function forcontu_bartik_preprocess(&$variables, $hook) {
  $variables['twig_debug'] = \Drupal::service('twig')->isDebug();
}
```

==现在，==新变量 `twig_debug` 将在系统的所有模板中可用。

要测试其功能，我们将修改 `page.html.twig` 模板，添加一个文本块，指示调试模式已启用。由于当前使用的 `page.html.twig` 模板是基础主题 Bartik 的模板，我们需要先将其复制到我们的主题中，而不重命名。然后在我们的主题中添加以下代码，当 `twig_debug` 变量为真时显示一个（可翻译的）文本。

```twig
<div id="page-wrapper">
  <div id="page">
    <header id="header" class="header" role="banner" aria-label="{{ 'Site header'|t }}">
      <div class="section layout-container clearfix">
        {{ page.secondary_menu }}
        {{ page.header }}
        {{ page.primary_menu }}
      </div>
    </header>
    {% if twig_debug %}
      <div class="twig-debug">
        {{ 'Twig Debug is enabled'|t }}
      </div>
    {% endif %}
    {% if page.highlighted %}
    ...
```

还将在主题的 `style.css` 文件中为 `twig-debug` 类添加样式。

```css
.twig-debug {
  background-color: #ffeb3b;
}
```

一旦从用户界面翻译中翻译了字符串，预期结果如图所示。

# 26.5 主题配置表单

每个主题都可以有特定的配置选项，这些选项可以在以下路径中找到：
```
管理 -> 外观 -> 主题 [选项]
```

要在主题配置表单中添加新选项，我们需要实现 `hook_form_system_theme_settings_alter()` 函数。此函数可以添加到 `.theme` 文件中，或新建一个名为 `theme-settings.php` 的文件中。
[API 文档](https://api.drupal.org/api/drupal/core!lib!Drupal!Core!Render!theme.api.php/function/hook_form_system_theme_settings_alter/10)

```php
/**
 * Implements hook_form_system_theme_settings_alter().
 */
function hook_form_system_theme_settings_alter(&$form, \Drupal\Core\Form\FormStateInterface $form_state) {
  // Your code here.
}
```

此函数允许修改主题配置表单，因此它接收处理表单时常用的参数：`$form` 和 `$form_state`。`$form` 是通过引用传递的参数，因此我们所做的任何更改（添加、修改或删除元素）都会反映在表单中。

我们将继续实现 Forcontu Bartik 主题，以添加一个复选框字段，用于指定是否显示在 `page.html.twig` 模板中添加的“Twig 调试”文本。==系统将负责将字段的值存储在自动为主题创建的配置中（`forcontu_bartik.settings`）。配置中的变量名称与表单元素的名称相同。==在我们的示例中是 `show_twig_message`。

```php
<?php
/**
 * Implements hook_form_system_theme_settings_alter().
 */
function forcontu_bartik_form_system_theme_settings_alter(&$form, \Drupal\Core\Form\FormStateInterface $form_state) {
  $form['forcontu_bartik'] = [
    '#type' => 'fieldset',
    '#title' => t('Bartik Forcontu settings'),
  ];
  $form['forcontu_bartik']['show_twig_message'] = [
    '#type' => 'checkbox',
    '#title' => t('Display "Twig Debug" message'),
    '#default_value' => theme_get_setting('show_twig_message'),
    '#description' => t('Check this option if you want to display a message when Twig Debug is enabled.'),
  ];
}
```

==要获取主题配置参数的值==，我们使用 `theme_get_setting()` 函数，并指定字段名称。
[API 文档](https://api.drupal.org/api/drupal/core!includes!theme.inc/function/theme_get_setting/10)

结果如图所示。
![[Pasted image 20240624114536.png]]
为了在模板中使用此值，我们需要通过某个预处理函数将其添加到 `$variables` 中。在我们的示例中，由于我们只在 `page.html.twig` 模板中显示文本，因此我们将实现 `hook_preprocess_page()` 函数。在这里我们也将使用 `theme_get_setting()` 函数来获取配置参数的值。

```php
<?php
/**
 * Implements hook_preprocess_HOOK() for page.html.twig.
 */
function forcontu_bartik_preprocess_page(&$variables) {
  $variables['show_twig_message'] = theme_get_setting('show_twig_message');
}
```

最后，我们将修改 `page.html.twig` 模板，使其仅在选项启用时显示消息。

```twig
{% if twig_debug and show_twig_message %}
  <div class="twig-debug">
    {{ 'Twig Debug is enabled'|t }}
  </div>
{% endif %}
```

### 默认值

我们还可以为配置变量指定默认值，这些值将在主题安装期间添加。为此，我们将定义一个配置文件 `config/install/theme_name.settings.yml`。

对于我们的主题，我们将创建文件：
```
config/install/forcontu_bartik.settings.yml
```

内容如下：

```yaml
features:
  node_user_picture: 1
  comment_user_picture: 1
  comment_user_verification: 1
  favicon: 1
logo:
  use_default: 1
favicon:
  use_default: 1
show_twig_message: 1
```

我们添加了新的自定义字段 `show_twig_message` 和其他配置选项，这些选项可能由基础主题或核心添加。

要快速了解可以在此配置文件中添加哪些变量，可以直接查看安装主题时创建的配置。正如我们已经看到的，可以通过控制台或 Devel 的 Config Editor 查看。记住，主题的配置文件名为 `theme_name.settings`（例如，`forcontu_bartik.settings`）。

最后，你需要禁用、卸载并重新安装主题，以测试配置文件中指定的默认值是否生效。